<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e1e1e">
  <title>FlashForge Web UI</title>
  <link rel="stylesheet" href="gridstack.min.css">
  <link rel="stylesheet" href="gridstack-extra.min.css">
  <link rel="stylesheet" href="webui.css">
  <script src="lucide.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Login Screen (initially visible) -->
    <div id="login-screen" class="login-screen">
      <div class="login-container">
        <h1>FlashForge Web UI</h1>
        <div class="login-form">
          <input type="password" id="password-input" placeholder="Enter password" autocomplete="current-password">
          <div class="remember-me">
            <label>
              <input type="checkbox" id="remember-me-checkbox">
              <span>Remember me</span>
            </label>
          </div>
          <button id="login-button">Login</button>
        </div>
        <div id="login-error" class="login-error"></div>
      </div>
    </div>

    <!-- Main UI (initially hidden) -->
    <div id="main-ui" class="main-ui hidden">
      <!-- Header Bar -->
      <div class="header">
        <div class="header-left">
          <div class="header-title">FlashForge Web UI</div>
        </div>
        <div class="header-center">
          <!-- Printer Selector (hidden when only one printer) -->
          <div class="printer-selector hidden" id="printer-selector">
            <label for="printer-select">Printer:</label>
            <select id="printer-select" class="printer-select">
              <option value="">Loading...</option>
            </select>
          </div>
        </div>
        <div class="header-right">
          <button id="edit-mode-toggle" class="edit-mode-toggle" aria-pressed="false">
            <i id="edit-mode-lock-icon" class="lock-icon" data-lucide="lock" aria-hidden="true"></i>
            <span class="edit-text">Locked</span>
          </button>
          <button
            id="settings-button"
            class="settings-button"
            aria-haspopup="dialog"
            aria-controls="settings-modal"
            title="WebUI Settings"
          >
            <i data-lucide="settings" aria-hidden="true"></i>
          </button>
          <div class="connection-status">
            <span class="connection-indicator" id="connection-indicator"></span>
            <span id="connection-text">Disconnected</span>
          </div>
          <button id="logout-button" class="logout-button">Logout</button>
        </div>
      </div>

      <!-- Main Layout -->
      <div class="main-layout">
        <!-- Desktop GridStack Layout -->
        <div class="grid-stack webui-grid webui-grid-desktop" id="webui-grid-desktop" aria-live="polite">
          <!-- Components injected dynamically via WebUIGridManager -->
        </div>

        <!-- Mobile Static Layout (hidden on desktop) -->
        <div class="webui-grid webui-grid-mobile hidden" id="webui-grid-mobile" aria-live="polite">
          <!-- Components injected in predefined mobile order -->
        </div>
      </div>

      <!-- Settings Modal -->
      <div id="settings-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="modal-content large">
          <div class="modal-header">
            <h2 id="settings-modal-title">WebUI Settings</h2>
            <button id="close-settings" class="close-btn" aria-label="Close settings">&times;</button>
          </div>
          <div class="modal-body">
            <section class="settings-section">
              <h3>Panel Visibility</h3>
              <label><input type="checkbox" id="toggle-camera" data-component-id="camera" checked> Camera View</label>
              <label><input type="checkbox" id="toggle-controls" data-component-id="controls" checked> Controls</label>
              <label><input type="checkbox" id="toggle-model-preview" data-component-id="model-preview" checked> Model Preview</label>
              <label><input type="checkbox" id="toggle-printer-state" data-component-id="printer-state" checked> Printer State</label>
              <label><input type="checkbox" id="toggle-temp-control" data-component-id="temp-control" checked> Temperature Control</label>
              <label><input type="checkbox" id="toggle-filtration-tvoc" data-component-id="filtration-tvoc" checked> Filtration &amp; TVOC</label>
              <label><input type="checkbox" id="toggle-spoolman-tracker" data-component-id="spoolman-tracker" checked> Spoolman Tracker</label>
              <label><input type="checkbox" id="toggle-job-progress" data-component-id="job-progress" checked> Job Progress</label>
              <label><input type="checkbox" id="toggle-job-details" data-component-id="job-details" checked> Job Details</label>
            </section>
            <section class="settings-section">
              <h3>Layout Customization</h3>
              <label class="toggle-edit-mode">
                <input type="checkbox" id="toggle-edit-mode">
                <span>Enable Edit Mode</span>
                <span class="help-text">Allows dragging and resizing panels</span>
              </label>
            </section>
            <section class="settings-section">
              <h3>Theme Colors</h3>
              <p class="help-text">Customize the WebUI color scheme. Changes apply when you click Apply.</p>
              <div class="theme-color-grid">
                <label>
                  <span>Primary Color:</span>
                  <input type="color" id="webui-theme-primary" class="color-input">
                </label>
                <label>
                  <span>Secondary Color:</span>
                  <input type="color" id="webui-theme-secondary" class="color-input">
                </label>
                <label>
                  <span>Background Color:</span>
                  <input type="color" id="webui-theme-background" class="color-input">
                </label>
                <label>
                  <span>Surface Color:</span>
                  <input type="color" id="webui-theme-surface" class="color-input">
                </label>
                <label>
                  <span>Text Color:</span>
                  <input type="color" id="webui-theme-text" class="color-input">
                </label>
              </div>
              <div class="theme-buttons">
                <button id="apply-webui-theme-btn" class="primary-btn">Apply Theme</button>
                <button id="reset-webui-theme-btn" class="secondary-btn">Reset to Default</button>
              </div>
            </section>
            <section class="settings-section">
              <h3>Reset</h3>
              <button id="reset-layout-btn" class="secondary-btn">Reset Layout to Default</button>
            </section>
          </div>
          <div class="modal-footer">
            <button id="save-settings-btn" class="primary-btn">Save</button>
          </div>
        </div>
      </div>

      <!-- File Selection Modal -->
      <div id="file-modal" class="modal hidden">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="modal-title">Select File</h2>
            <button id="close-modal" class="close-btn">&times;</button>
          </div>
          <div class="modal-body">
            <div id="file-list" class="file-list"></div>
          </div>
          <div class="modal-footer">
            <label class="checkbox-label">
              <input type="checkbox" id="auto-level">
              <span>Auto Level</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="start-now" checked>
              <span>Start Now</span>
            </label>
            <button id="print-file-btn" class="primary-btn" disabled>Print</button>
          </div>
        </div>
      </div>

      <!-- Material Matching Modal -->
      <div id="material-matching-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="material-matching-title">
        <div class="modal-content material-matching">
          <div class="modal-header">
            <h2 id="material-matching-title">Match Materials</h2>
            <button id="material-matching-close" class="close-btn" aria-label="Close material matching">&times;</button>
          </div>
          <div class="modal-body">
            <p class="material-matching-description">
              Match each material used in your print to the corresponding material station slot. Material types must match (for example, PLA to PLA).
            </p>
            <div id="material-matching-error" class="material-matching-message error hidden" role="alert"></div>
            <div id="material-matching-warning" class="material-matching-message warning hidden" role="status"></div>
            <div class="material-matching-layout">
              <section class="material-column">
                <h3>Job Requirements</h3>
                <div id="material-job-requirements" class="material-list"></div>
              </section>
              <section class="material-column">
                <h3>Material Station</h3>
                <div id="material-slot-list" class="material-list"></div>
              </section>
            </div>
            <section class="material-mappings-section">
              <h3>Current Mappings</h3>
              <div id="material-mappings" class="material-mappings"></div>
            </section>
          </div>
          <div class="modal-footer">
            <button id="material-matching-cancel" class="secondary-btn" type="button">Cancel</button>
            <button id="material-matching-confirm" class="primary-btn" type="button" disabled>Start Print</button>
          </div>
        </div>
      </div>

      <!-- Spoolman Spool Selection Modal -->
      <div id="spoolman-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="spoolman-modal-title">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="spoolman-modal-title">Select Spool</h2>
            <button id="spoolman-modal-close" class="close-btn" aria-label="Close spool selection">&times;</button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              id="spoolman-search"
              placeholder="Search spools by name, vendor, or material..."
              class="spoolman-search-input"
              aria-label="Search spools"
            >
            <div id="spoolman-spool-list" class="spoolman-spool-list" role="list">
              <!-- Populated dynamically -->
            </div>
            <div id="spoolman-no-results" class="spoolman-no-results hidden">No spools found</div>
            <div id="spoolman-loading" class="spoolman-loading hidden">Loading spools...</div>
          </div>
          <div class="modal-footer">
            <button id="spoolman-clear-spool" class="secondary-btn" type="button">Clear Active Spool</button>
            <button id="spoolman-modal-cancel" class="secondary-btn" type="button">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Temperature Input Dialog -->
      <div id="temp-dialog" class="modal hidden">
        <div class="modal-content small">
          <div class="modal-header">
            <h2 id="temp-dialog-title">Set Temperature</h2>
            <button id="close-temp-dialog" class="close-btn">&times;</button>
          </div>
          <div class="modal-body">
            <p id="temp-dialog-message">Enter temperature (Â°C):</p>
            <input type="number" id="temp-input" min="0" max="300" step="5" value="0">
          </div>
          <div class="modal-footer">
            <button id="temp-cancel" class="secondary-btn">Cancel</button>
            <button id="temp-confirm" class="primary-btn">Set</button>
          </div>
        </div>
      </div>

      <!-- Printer Discovery Modal -->
      <div id="discovery-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="discovery-modal-title">
        <div class="modal-content large">
          <div class="modal-header">
            <h2 id="discovery-modal-title">Add Printer</h2>
            <button id="close-discovery" class="close-btn" aria-label="Close discovery">&times;</button>
          </div>
          <div class="modal-body">
            <div class="discovery-tabs">
              <button class="discovery-tab-btn active" data-tab="scan">
                <i data-lucide="wifi" aria-hidden="true"></i> Network Scan
              </button>
              <button class="discovery-tab-btn" data-tab="manual">
                <i data-lucide="keyboard" aria-hidden="true"></i> Manual Entry
              </button>
              <button class="discovery-tab-btn" data-tab="saved">
                <i data-lucide="archive" aria-hidden="true"></i> Saved Printers
              </button>
            </div>

            <div class="discovery-tab-content">
              <!-- Network Scan Tab -->
              <div class="discovery-tab-pane" id="discovery-tab-scan">
                <p class="help-text">
                  Scan your local network to automatically discover FlashForge printers.
                </p>

                <button class="btn btn-primary btn-block" id="discovery-scan-btn">
                  <i data-lucide="search" aria-hidden="true"></i> Start Network Scan
                </button>

                <div class="scan-progress hidden" id="discovery-scan-progress">
                  <div class="spinner"></div>
                  <p>Scanning network... This may take up to 30 seconds.</p>
                </div>

                <div class="discovered-printers-container hidden" id="discovery-discovered-printers">
                  <h3>Discovered Printers</h3>
                  <div class="printer-list" id="discovery-printer-list"></div>
                </div>
              </div>

              <!-- Manual Entry Tab -->
              <div class="discovery-tab-pane hidden" id="discovery-tab-manual">
                <p class="help-text">
                  Enter the IP address of your printer to connect directly.
                </p>

                <div class="form-group">
                  <label for="discovery-manual-ip">IP Address</label>
                  <input type="text" id="discovery-manual-ip" class="form-control" placeholder="192.168.1.100" />
                </div>

                <div class="form-group">
                  <label for="discovery-printer-type">Printer Type</label>
                  <select id="discovery-printer-type" class="form-control">
                    <option value="new">5M / 5M Pro (New API)</option>
                    <option value="legacy">Legacy Printers (Old API)</option>
                  </select>
                </div>

                <div class="form-group" id="discovery-check-code-group">
                  <label for="discovery-check-code">Check Code</label>
                  <input type="text" id="discovery-check-code" class="form-control" placeholder="12345678" maxlength="8" />
                  <small class="form-text">Required for 5M/Pro printers. Found in printer settings.</small>
                </div>

                <button class="btn btn-primary btn-block" id="discovery-manual-connect">
                  <i data-lucide="link" aria-hidden="true"></i> Connect to Printer
                </button>
              </div>

              <!-- Saved Printers Tab -->
              <div class="discovery-tab-pane hidden" id="discovery-tab-saved">
                <p class="help-text">
                  Reconnect to a previously saved printer.
                </p>

                <div class="saved-printers-list" id="discovery-saved-printers-list">
                  <p class="text-muted">Loading saved printers...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast Notification -->
      <div id="toast" class="toast hidden"></div>
    </div>
  </div>

  <!-- JSMpeg library for RTSP streaming (vendored locally) -->
  <script src="jsmpeg.min.js"></script>

  <!-- GridStack library for drag-and-drop layout management -->
  <script src="gridstack-all.js"></script>

  <!-- TypeScript compiled to JavaScript -->
  <script type="module" src="app.js"></script>
</body>
</html>
